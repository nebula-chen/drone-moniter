<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>中山大学智能工程学院无人机管控平台</title>
<!--加载高德地图、three.js插件-->
<script src="https://webapi.amap.com/maps?v=2.0&key=0ab0f0b45664f7b5d7f3030df28d12f0&plugin=AMap.Scale,AMap.ToolBar,AMap.MapType,Map3D,AMap.Buildings"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.142/build/three.js"></script>
<!--设置是否为缩放模式 -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- 新 Bootstrap 核心 CSS 文件 --> 
<link rel="stylesheet" type="text/css" href="https://apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.css">
<!-- jQuery文件。务必在bootstrap.min.js 之前引入 --> 
<script src="js/jquery.min.js"></script>
<!-- 最新的 Bootstrap 核心 JavaScript 文件 --> 
<script src="js/bootstrap.min.js"></script>
<!--echarts JS-->
<script src="js/echarts.min.js"></script>
<!-- 轮播swiper文件 -->
<link rel="stylesheet" type="text/css" href="css/swiper.min.css">
<script src="js/swiper.min.js"></script>
<!--界面样式-->
<script src="js/visual.js"></script>
<script src="js/china.js"></script>
<script src="js/droneMap.js"></script>
<!-- <script src="js/chartMap.js"></script> -->
<link rel="stylesheet" type="text/css" href="css/visual.css">

</head>
<body class="ksh">
	<div id="load">
		<div class="load_img"><!-- 加载动画 -->
			<img class="jzxz1" src="images/jzxz1.png">
			<img class="jzxz2" src="images/jzxz2.png">
		</div>
	</div>
	<div class="head_top">
		<!-- <img class="img-responsive" src="images/jcdsj_logo.gif"> -->
		<h2>中山大学智能工程学院无人机管控平台</h2>
	</div>
	<div class="visual">
		<div class="visual_left">
			<div class="visual_box">
				<div class="visual_title">
					<span>飞行架次统计</span>
					<img src="images/ksh33.png">
				</div>
				<div class="visual_chart_switch">
					<button id="btn-year">年</button>
					<button id="btn-month">月</button>
					<button id="btn-day" class="active">日</button>
				</div>
				<div class="visual_chart" id="main1"></div>
			</div>
			<div class="visual_box">
				<div class="visual_title">
					<span>飞行耗电统计</span>
					<img src="images/ksh33.png">
				</div>
				<div class="visual_chart_switch">
					<button id="btn-year-soc">年</button>
					<button id="btn-month-soc">月</button>
					<button id="btn-day-soc" class="active">日</button>
				</div>
				<div class="visual_chart" id="main_soc"></div>
			</div>
			<div class="visual_box">
				<div class="visual_title">
					<span>xxx统计</span>
					<img src="images/ksh33.png">
				</div>
			</div>
		</div>
		<div class="visual_con">
			<div class="visual_conTop">
				<div class="visual_conTop_box visual_conTop1">
					<div>
						<h3>飞行架次</h3>
						<p>343</p>
					</div>
				</div>
				<div class="visual_conTop_box visual_conTop1">
					<div>
						<h3>航程(km)</h3>
						<p>2498.26</p>
					</div>
				</div>
				<div class="visual_conTop_box visual_conTop1">
					<div>
						<h3>飞行时长(min)</h3>
						<p>58.68</p>
					</div>
				</div>
				<div class="visual_conTop_box visual_conTop1">
					<div>
						<h3>当前架次</h3>
						<p>2</p>
					</div>
				</div>
				<div class="clear"></div>
			</div>
			<div class="visual_conBot">
				<img class="visual_conBot_l" src="images/ksh42.png">
				<img class="visual_conBot_2" src="images/ksh43.png">
				<img class="visual_conBot_3" src="images/ksh44.png">
				<img class="visual_conBot_4" src="images/ksh45.png">
				<div class="visual_chart_text">
					<h2>实时轨迹显示</h2>
				</div>
				<div class="visual_chart" id="main8" style="position:relative;">
					<div id="map-scene"></div>
					<div class="loading" id="loading">正在加载3D地图...</div>
					<div class="connection-status disconnected" id="connection-status">连接状态: 未连接</div>
					<div class="info-panel no-selection" id="info-panel">
						<h3>无人机状态</h3>
						<p id="selection-hint">点击地图上的无人机图标查看详细信息</p>
						<div id="drone-info" style="display: none;">
							<p>速度: <span id="speed-info">0</span> m/s</p>
							<p>海拔高度: <span id="altitude-info">0</span> m</p>
							<p>对地高度: <span id="height-info">0</span> m</p>
							<p>经度: <span id="longitude">0</span>°</p>
							<p>纬度: <span id="latitude">0</span>°</p>
							<p>无人机ID: <span id="uav-id">-</span></p>
							<p>电池电量: <span id="soc">-</span></p>
						</div>
					</div>
					<div class="control-panel">
						<div class="control-group">
							<button class="control-btn" id="rotateLeft">←旋转</button>
							<button class="control-btn reset" id="resetRotation">重置</button>
							<button class="control-btn" id="rotateRight">旋转→</button>
						</div>
						<div class="control-group">
							<button class="control-btn" id="pitchUp">⋀视角</button>
							<button class="control-btn" id="pitchDown">⋁视角</button>
						</div>
						<div class="control-group">
							<button class="control-btn" id="zoomIn">放大</button>
							<button class="control-btn" id="zoomOut">缩小</button>
						</div>
						<div class="control-group">
							<button class="control-btn toggle active" id="togglePaths">隐藏轨迹</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="visual_right">
			<div class="visual_box">
				<div class="visual_title">
					<span>xxx数据统计</span>
					<img src="images/ksh33.png">
				</div>
				<div class="visual_chart" id="main3"></div>
			</div>
            <div class="visual_rightCon">
                <div class="visual_rightCon_box">
                    <div>
                        <h3>平均飞行速度(km/h)</h3>
                        <p>10.0</p>
                    </div>
                </div>
                <div class="visual_rightCon_box">
                    <div>
                        <h3>平均飞行时间(min)</h3>
                        <p>10.0</p>
                    </div>
                </div>
                <div class="visual_rightCon_box">
                    <div>
                        <h3>平均耗电(百分比)</h3>
                        <p>10.0</p>
                    </div>
                </div>
                <div class="visual_rightCon_box">
                    <div>
                        <h3>平均载货量(kg)</h3>
                        <p>10.0</p>
                    </div>
                </div>
            </div>
			<!-- <div class="visual_box">
				<div class="visual_title">
					<span>其他</span>
					<img src="images/ksh33.png">
				</div>
				<!-- <div class="swiper-container visual_swiper2 visual_chart">

				</div> -->
			</div> -->
            <button class="bottom-jump-btn" onclick="window.location.href='http://192.168.1.108:8080/recordsui'">页面跳转</button>
		</div>
		<div class="clear"></div>
	</div>
	<script type="text/javascript">
		function loadFlightStats() {
			$.ajax({
				url: "/record/stats",
				type: "POST",
				contentType: "application/json",
				success: function(res) {
					// 假设返回格式为 { totalCount: 123, totalDistance: 456.78, totalTime: 12345 }
					// 填充到页面
					// 飞行架次
					$('.visual_conTop_box:eq(0) p').text(res.totalCount);
					// 航程(km)，保留两位小数
					$('.visual_conTop_box:eq(1) p').text((res.totalDistance / 1000).toFixed(2));
					// 飞行时长(h)，totalTime单位为秒，转小时，保留两位小数
					$('.visual_conTop_box:eq(2) p').text((res.totalTime / 3600).toFixed(2));
				},
				error: function() {
					// 失败时可选提示
					$('.visual_conTop_box:eq(0) p').text('--');
					$('.visual_conTop_box:eq(1) p').text('--');
					$('.visual_conTop_box:eq(2) p').text('--');
				}
			});
		}

		function loadOnlineCount() {
			$.ajax({
				url: "/api/drone/online_count",
				type: "GET",
				success: function(res) {
					$('.visual_conTop_box:eq(3) p').text(res.count);
				},
				error: function() {
					$('.visual_conTop_box:eq(3) p').text('--');
				}
			});
		} 
		
		function updateFlightChart(type, stats) {
			let xAxis = [];
			let yAxis = [];
			if (type === 'year') {
				xAxis = (stats.yearStats || []).map(item => item.date);
				yAxis = (stats.yearStats || []).map(item => item.count);
			} else if (type === 'month') {
				xAxis = (stats.monthStats || []).map(item => item.date.slice(5)); // 取 MM 部分
				yAxis = (stats.monthStats || []).map(item => item.count);
			} else {
				xAxis = (stats.dayStats || []).map(item => item.date.slice(5)); // 取 MM-DD 部分
				yAxis = (stats.dayStats || []).map(item => item.count);
			}
			option1.xAxis = xAxis;
			if (option1.series && option1.series.length > 0) {
				option1.series[0].data = yAxis;
			}
			myChart1.setOption({
				xAxis: { data: xAxis },
				series: [{ data: yAxis }]
			});
		}

		let cachedStats = null;
		function loadRecordsTimeSeries(type = 'day') {
			$.ajax({
				url: "/record/timeSeries",
				type: "GET",
				success: function(res) {
					cachedStats = res;
					updateFlightChart(type, res);
				}
			});
		}

		// 飞行架次统计按钮
		$('#btn-year').click(function() {
			$('#btn-year,#btn-month,#btn-day').removeClass('active');
			$(this).addClass('active');
			if (cachedStats) updateFlightChart('year', cachedStats);
		});
		$('#btn-month').click(function() {
			$('#btn-year,#btn-month,#btn-day').removeClass('active');
			$(this).addClass('active');
			if (cachedStats) updateFlightChart('month', cachedStats);
		});
		$('#btn-day').click(function() {
			$('#btn-year,#btn-month,#btn-day').removeClass('active');
			$(this).addClass('active');
			if (cachedStats) updateFlightChart('day', cachedStats);
		});

		// ================== 飞行耗电统计 ================== //
		var optionSOC = JSON.parse(JSON.stringify(option1));
		optionSOC.series[0].name = '耗电量';
		optionSOC.title.text = '';
		optionSOC.series[0].data = [];
		optionSOC.xAxis.data = [];

		function updateSOCChart(type, stats) {
			let xAxis = [];
			let yAxis = [];
			if (type === 'year') {
				xAxis = (stats.yearStats || []).map(item => item.date);
				yAxis = (stats.yearStats || []).map(item => item.usage);
			} else if (type === 'month') {
				xAxis = (stats.monthStats || []).map(item => item.date.slice(5));
				yAxis = (stats.monthStats || []).map(item => item.usage);
			} else {
				xAxis = (stats.dayStats || []).map(item => item.date.slice(5));
				yAxis = (stats.dayStats || []).map(item => item.usage);
			}
			myChartSOC.setOption({
				xAxis: { data: xAxis },
				series: [{ name: '耗电量', data: yAxis }]
			});
		}

		let cachedSOCStats = null;
		function loadSOCUsageStats(type = 'day') {
			$.ajax({
				url: "/record/SOCUsage",
				type: "GET",
				success: function(res) {
					cachedSOCStats = res;
					updateSOCChart(type, res);
				}
			});
		}

		// 飞行耗电统计按钮
		$('#btn-year-soc').click(function() {
			$('#btn-year-soc,#btn-month-soc,#btn-day-soc').removeClass('active');
			$(this).addClass('active');
			if (cachedSOCStats) updateSOCChart('year', cachedSOCStats);
		});
		$('#btn-month-soc').click(function() {
			$('#btn-year-soc,#btn-month-soc,#btn-day-soc').removeClass('active');
			$(this).addClass('active');
			if (cachedSOCStats) updateSOCChart('month', cachedSOCStats);
		});
		$('#btn-day-soc').click(function() {
			$('#btn-year-soc,#btn-month-soc,#btn-day-soc').removeClass('active');
			$(this).addClass('active');
			if (cachedSOCStats) updateSOCChart('day', cachedSOCStats);
		});

		$(function(){
			var a=$('.visualSssf_left a')
			for(var i=0;i<a.length;i++){
				a[i].index=i;
				a[i].onclick=function(){
					for(var i=0;i<a.length;i++){
						a[i].className=''
						}
					this.className='active'
				}
			}

			var sfzcllH=$('.sfzcll_box').height()
			var sfzcllHtwo=sfzcllH-2
			$('.sfzcll_box').css('line-height',sfzcllH+'px')
			$('.sfzcll_smallBk>div').css('line-height',sfzcllHtwo+'px')

			//删除加载动画
			$('#load').fadeOut(1000)
			setTimeout(function(){    
				$('#load').remove()
			}
			,1100);

			loadFlightStats(); // 加载飞行架次、航程、飞行时长
			loadOnlineCount(); // 加载当前架次
			loadRecordsTimeSeries(); // 默认加载日统计
			loadSOCUsageStats(); // 默认加载日统计

			setInterval(loadFlightStats, 5 * 60 * 1000); // 每5分钟刷新一次
			setInterval(loadOnlineCount, 10000); // 每10秒刷新一次在线架次
		})

		//交通流量
		var myChart1 = echarts.init(document.getElementById('main1'));
		myChart1.setOption(option1);
		//本月发生事件
		var myChartSOC = echarts.init(document.getElementById('main_soc'));
		myChartSOC.setOption(optionSOC);

		var myChart3 = echarts.init(document.getElementById('main3'));
		myChart3.setOption(option3);
		var mySwiper1 = new Swiper('.visual_swiper1', {
			autoplay: true,//可选选项，自动滑动
			speed:800,//可选选项，滑动速度
			autoplay: {
				delay: 5000,//5秒切换一次
			},
		})
	</script>
</body>
</html>
